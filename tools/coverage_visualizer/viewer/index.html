<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coverage Visualizer</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="app">
    <header class="header">
      <h1>ğŸ“Š Coverage Visualizer</h1>

      <div class="file-loader">
        <input type="file" accept=".json" @change="loadJSON" id="file-input">
        <label for="file-input" class="file-label">Choose JSON File</label>
        <span class="file-hint">or auto-scan data/ directory</span>
      </div>

      <div v-if="jsonData" class="stats-panel">
        <span class="stat">
          <span class="stat-label">Coverage:</span>
          <span class="stat-value" :class="getCoverageClass()">{{ coveragePercentage }}%</span>
        </span>
        <span class="stat">
          <span class="stat-label">Chunks:</span>
          <span class="stat-value">{{ totalChunks }}</span>
        </span>
        <span class="stat">
          <span class="stat-label">Significant Gaps:</span>
          <span class="stat-value">{{ significantGaps }}</span>
        </span>
      </div>

      <div v-if="jsonData" class="threshold-control">
        <label>Similarity Threshold:</label>
        <input
          type="range"
          min="80"
          max="100"
          v-model.number="threshold"
          class="threshold-slider"
        >
        <span class="threshold-value">{{ threshold }}%</span>
      </div>

      <div v-if="error" class="error-message">
        âŒ {{ error }}
      </div>

      <div v-if="loading" class="loading-message">
        â³ Loading...
      </div>
    </header>

    <main v-if="jsonData" class="main-container">
      <div class="left-panel" @scroll="onLeftScroll" ref="leftPanel">
        <h2>ğŸ“„ Original Document</h2>
        <div class="document-name">{{ jsonData.metadata.document_name }}</div>

        <div class="document-content">
          <span
            v-for="(segment, index) in coverageMap"
            :key="index"
            :class="['segment', getSegmentClass(segment), { 'segment-active': activeSegmentIndex === index }]"
            @click="onSegmentClick(segment, index)"
            :title="getSegmentTitle(segment)"
          >{{ getSegmentText(segment) }}</span>
        </div>
      </div>

      <div class="right-panel" @scroll="onRightScroll" ref="rightPanel">
        <h2>ğŸ“¦ Chunks ({{ filteredChunks.length }})</h2>

        <div class="chunks-list">
          <div
            v-for="chunk in filteredChunks"
            :key="chunk.chunk_id"
            :class="['chunk-card', { 'active': activeChunkId === chunk.chunk_id }]"
            @click="onChunkClick(chunk)"
            @mouseenter="onChunkHover(chunk)"
            @mouseleave="onChunkLeave"
          >
            <div class="chunk-header">
              <span class="chunk-id">{{ chunk.chunk_id }}</span>
              <span
                class="similarity-badge"
                :class="getSimilarityClass(chunk.similarity)"
              >
                {{ (chunk.similarity * 100).toFixed(1) }}%
              </span>
            </div>

            <div class="chunk-meta">
              <span class="chunk-position">
                ğŸ“ Position: {{ chunk.match_start }} - {{ chunk.match_end }}
              </span>
              <span v-if="chunk.metadata.section_title" class="chunk-section">
                ğŸ“„ {{ chunk.metadata.section_title }}
              </span>
            </div>

            <div v-if="expandedChunkId === chunk.chunk_id" class="chunk-preview">
              <p><strong>Extracted Text:</strong></p>
              <pre class="chunk-text">{{ chunk.extracted_text.substring(0, 500) }}{{ chunk.extracted_text.length > 500 ? '...' : '' }}</pre>

              <p v-if="chunk.contextual_prefix"><strong>Context:</strong></p>
              <p v-if="chunk.contextual_prefix" class="chunk-context">{{ chunk.contextual_prefix }}</p>
            </div>

            <button
              @click.stop="toggleExpanded(chunk.chunk_id)"
              class="expand-button"
            >
              {{ expandedChunkId === chunk.chunk_id ? 'â–² Collapse' : 'â–¼ Expand' }}
            </button>
          </div>
        </div>
      </div>
    </main>

    <div v-else-if="!loading && !error" class="welcome-screen">
      <h2>ğŸ‘‹ Welcome to Coverage Visualizer</h2>
      <p>Load a coverage report JSON file to begin visualization.</p>
      <ol>
        <li>Run the Python analyzer to generate a coverage report</li>
        <li>Click "Choose JSON File" to load the report</li>
        <li>Explore coverage with interactive visualization</li>
      </ol>
    </div>
  </div>

  <!-- Load Vue 3 from CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
